!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@type-r/models")):"function"==typeof define&&define.amd?define(["exports","@type-r/models"],e):e((t=t||self).restfulIO={},t.Nested)}(this,function(t,i){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var u=function(){return(u=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function c(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(t);o<n.length;o++)e.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(t,n[o])&&(r[n[o]]=t[n[o]])}return r}function s(i,s,u,c){return new(u=u||Promise)(function(t,e){function r(t){try{o(c.next(t))}catch(t){e(t)}}function n(t){try{o(c.throw(t))}catch(t){e(t)}}function o(e){e.done?t(e.value):new u(function(t){t(e.value)}).then(r,n)}o((c=c.apply(i,s||[])).next())})}function a(r,n){var o,i,s,t,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,i&&(s=2&e[0]?i.return:e[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return u.label++,{value:e[1],done:!1};case 5:u.label++,i=e[1],e=[0];continue;case 7:e=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){u=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){u.label=e[1];break}if(6===e[0]&&u.label<s[1]){u.label=s[1],s=e;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(e);break}s[2]&&u.ops.pop(),u.trys.pop();continue}e=n.call(r,u)}catch(t){e=[6,t],i=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function p(t,e){return void 0===t&&(t=[]),void 0===e&&(e=50),new n(t,e)}var n=(e.prototype.resolve=function(r){var n=this;return i.createIOPromise(function(t,e){setTimeout(function(){return t(r)},n.delay)})},e.prototype.reject=function(r){var n=this;return i.createIOPromise(function(t,e){setTimeout(function(){return e(r)},n.delay)})},e.prototype.generateId=function(t){var e=Number(t);return isNaN(e)||(this.index[0]=Math.max(this.index[0],e)),t||String(this.index[0]++)},e.prototype.create=function(t,e){var r=t.id=this.generateId(t.id);return this.index.push(r),this.items[r]=t,this.resolve({id:r})},e.prototype.update=function(t,e,r){return this.items[t]=e,this.resolve({})},e.prototype.read=function(t,e){var r=this.items[t];return r?this.resolve(r):this.reject("Not found")},e.prototype.destroy=function(e,t){return this.items[e]?(delete this.items[e],this.index=this.index.filter(function(t){return t!==e}),this.resolve({})):this.reject("Not found")},e.prototype.list=function(t){var e=this;return this.resolve(this.index.slice(1).map(function(t){return e.items[t]}))},e.prototype.subscribe=function(t){},e.prototype.unsubscribe=function(t){},e);function e(t,e){this.delay=e,this.index=[0],this.items={};for(var r=0,n=t;r<n.length;r++){var o=n[r];this.create(o,{})}}function o(t,e){return new f(t,e)}var f=(l.prototype.create=function(t,e,r){var n=this.collectionUrl(r,e);return this.memoryIO?this.simulateIO("create","POST",n,arguments):this.request("POST",n,e,t)},l.prototype.update=function(t,e,r,n){var o=this.objectUrl(n,t,r);return this.memoryIO?this.simulateIO("update","PUT",o,arguments):this.request("PUT",o,r,e)},l.prototype.read=function(t,e,r){var n=this.objectUrl(r,t,e);return this.memoryIO?this.simulateIO("read","GET",n,arguments):this.request("GET",n,e)},l.prototype.destroy=function(t,e,r){var n=this.objectUrl(r,t,e);return this.memoryIO?this.simulateIO("destroy","DELETE",n,arguments):this.request("DELETE",n,e)},l.prototype.list=function(t,e){var r=this.collectionUrl(e,t);return this.memoryIO?this.simulateIO("list","GET",r,arguments):this.request("GET",r,t)},l.prototype.subscribe=function(t){},l.prototype.unsubscribe=function(t){},l.prototype.simulateIO=function(e,r,n,o){return s(this,void 0,void 0,function(){return a(this,function(t){return i.log(i.isProduction?"error":"info","Type-R:SimulatedIO",r+" "+n),[2,this.memoryIO[e].apply(this.memoryIO,o)]})})},l.prototype.isRelativeUrl=function(t){return 0===t.indexOf("./")},l.prototype.removeTrailingSlash=function(t){return"/"===t.charAt(t.length-1)?t.substr(0,t.length-1):t},l.prototype.getRootUrl=function(t){var e=this.url;if(this.isRelativeUrl(e)){var r=t.getOwner(),n=r.getEndpoint().getUrl(r);return this.removeTrailingSlash(n)+"/"+e.substr(2)}return e},l.prototype.getUrl=function(t){var e=this.getRootUrl(t);return t.isNew()?e:this.removeTrailingSlash(e)+"/"+t.id},l.prototype.objectUrl=function(t,e,r){return h(this.getUrl(t),r.params)},l.prototype.collectionUrl=function(t,e){return h(this.getRootUrl(t),e.params)},l.prototype.buildRequestOptions=function(t,e,r){var n=u({},l.defaultFetchOptions,this.fetchOptions,e),o=n.headers,i=c(n,["headers"]),s=u({method:t,headers:u({"Content-Type":"application/json"},o)},i);return r&&(s.body=JSON.stringify(r)),s},l.prototype.request=function(t,e,r,n){var o=r.options;return fetch(e,this.buildRequestOptions(t,o,n)).then(function(t){if(t.ok)return t.json();throw new Error(t.statusText)})},l.defaultFetchOptions={cache:"no-cache",credentials:"same-origin",mode:"cors",redirect:"error"},l);function l(t,e){void 0===e&&(e={});var r=e.mockData,n=e.simulateDelay,o=void 0===n?1e3:n,i=c(e,["mockData","simulateDelay"]);this.url=t,this.fetchOptions=i,this.memoryIO=r?p(r,o):null}function h(t,e){var r=encodeURIComponent;return e?t+"?"+Object.keys(e).map(function(t){return r(t)+"="+r(e[t])}).join("&"):t}function d(t){throw new ReferenceError("Method "+t+" is not supported. modelFetchIO supports only model.fetch().")}var y,v,m,b=(r(y=g,v=m=f),void(y.prototype=null===v?Object.create(v):(O.prototype=v.prototype,new O)),g.prototype.list=function(){return s(this,void 0,void 0,function(){return a(this,function(t){return d("collection.fetch()"),[2]})})},g.prototype.destroy=function(){return s(this,void 0,void 0,function(){return a(this,function(t){return d("model.destroy()"),[2]})})},g.prototype.create=function(){return s(this,void 0,void 0,function(){return a(this,function(t){return d("model.save()"),[2]})})},g.prototype.update=function(){return s(this,void 0,void 0,function(){return a(this,function(t){return d("model.save()"),[2]})})},g.prototype.read=function(t,e,r){return s(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return this.url=this.constructUrl(e.params,r),this.memoryIO?(i.log(i.isProduction?"error":"info","Type-R:SimulatedIO","GET "+this.url),[4,this.memoryIO.list(e)]):[3,2];case 1:return[2,t.sent()[0]];case 2:return[2,this.request(this.method,this.getRootUrl(r),e)]}})})},g=function(t,e,r,n){var o,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var u=t.length-1;0<=u;u--)(o=t[u])&&(s=(i<3?o(s):3<i?o(e,r,s):o(e,r))||s);return 3<i&&s&&Object.defineProperty(e,r,s),s}([i.define],g));function O(){this.constructor=y}function g(t,e,r){void 0===r&&(r={});var n=r.mockData,o=c(r,["mockData"]),i=m.call(this,"",n?u({mockData:[n]},o):o)||this;return i.method=t,i.constructUrl=e,i}var I={parse:!0,strict:!0};var w=(Object.defineProperty(j.prototype,"endpoint",{get:function(){return this.Record.prototype._endpoint},enumerable:!0,configurable:!0}),j.prototype.subscribe=function(e,r){return s(this,void 0,void 0,function(){return a(this,function(t){return[2,this.endpoint.subscribe(e,r)]})})},j.prototype.unsubscribe=function(t,e){this.endpoint.unsubscribe(t,e)},j.prototype.list=function(r){return s(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return[4,(e=new this.Record.Collection).fetch(r)];case 1:return t.sent(),[2,e.toJSON()]}})})},j.prototype.update=function(n,o,i){return s(this,void 0,void 0,function(){var e,r;return a(this,function(t){switch(t.label){case 0:return o.id=n,[4,(e=this.Record.from(o,I)).save(i)];case 1:return t.sent(),x(r={_cas:e._cas},e,this.options.updateAttrs),[2,r]}})})},j.prototype.create=function(n,o){return s(this,void 0,void 0,function(){var e,r;return a(this,function(t){switch(t.label){case 0:return[4,(e=this.Record.from(n,I)).save(o)];case 1:return t.sent(),x(r={id:e.id,_cas:e._cas,_type:e._type},e,this.options.createAttrs),[2,r]}})})},j.prototype.read=function(r,n){return s(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return[4,(e=new this.Record({id:r})).fetch(n)];case 1:return t.sent(),[2,e.toJSON()]}})})},j.prototype.destroy=function(e,r){return s(this,void 0,void 0,function(){return a(this,function(t){return[2,this.endpoint.destroy(e,r)]})})},j);function j(t,e){var r=this;void 0===e&&(e={}),this.options={},this.Record=t,e.createAttrs&&(this.options.createAttrs=e.createAttrs.split(/\s+/)),e.updateAttrs&&(this.options.updateAttrs=e.updateAttrs.split(/\s+/));var n=Object.getPrototypeOf(this.endpoint);Object.keys(n).forEach(function(t){r[t]||"function"!=typeof n[t]||(r[t]=function(){return n[t].apply(this.endpoint,arguments)})})}function x(t,e,r){if(r)for(var n=e.toJSON(),o=0,i=r;o<i.length;o++){var s=i[o];t[s]=n[s]}}var S=(P.prototype.resolve=function(r){return i.createIOPromise(function(t,e){setTimeout(function(){t(r)},0)})},P.prototype.reject=function(r){return i.createIOPromise(function(t,e){setTimeout(function(){return e(r)},0)})},P.prototype.create=function(t,e){var r=this.index;return r.push(t.id=String(r[0]++)),this.index=r,this.set(t),this.resolve({id:t.id})},P.prototype.set=function(t){localStorage.setItem(this.key+"#"+t.id,JSON.stringify(t))},P.prototype.get=function(t){return JSON.parse(localStorage.getItem(this.key+"#"+t))},P.prototype.update=function(t,e,r){return e.id=t,this.set(e),this.resolve({})},P.prototype.read=function(t,e){var r=this.get(t);return r?this.resolve(r):this.reject("Not found")},P.prototype.destroy=function(e,t){return this.get(e)?(localStorage.removeItem(this.key+"#"+e),this.index=this.index.filter(function(t){return t!==e}),this.resolve({})):this.reject("Not found")},Object.defineProperty(P.prototype,"index",{get:function(){return JSON.parse(localStorage.getItem(this.key))||[0]},set:function(t){localStorage.setItem(this.key,JSON.stringify(t))},enumerable:!0,configurable:!0}),P.prototype.list=function(t){var e=this;return this.index,this.resolve(this.index.slice(1).map(function(t){return e.get(t)}))},P.prototype.subscribe=function(t){},P.prototype.unsubscribe=function(t){},P);function P(t){this.key=t}t.LocalStorageEndpoint=S,t.MemoryEndpoint=n,t.ProxyEndpoint=w,t.RestfulEndpoint=f,t.create=o,t.fetchModelIO=function(t,e,r){return new b(t,e,r)},t.localStorageIO=function(t){return new S(t)},t.memoryIO=p,t.proxyIO=function(t,e){return void 0===e&&(e={}),new w(t,e)},t.restfulIO=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
