!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@type-r/models")):"function"==typeof define&&define.amd?define(["exports","@type-r/models"],e):e((t=t||self).restfulIO={},t.Nested)}(this,function(t,s){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var u=function(){return(u=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var o in e=arguments[r])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function c(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(t);o<n.length;o++)e.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(t,n[o])&&(r[n[o]]=t[n[o]])}return r}function p(t,s,u,c){return new(u=u||Promise)(function(e,r){function n(t){try{i(c.next(t))}catch(t){r(t)}}function o(t){try{i(c.throw(t))}catch(t){r(t)}}function i(t){t.done?e(t.value):function(e){return e instanceof u?e:new u(function(t){t(e)})}(t.value).then(n,o)}i((c=c.apply(t,s||[])).next())})}function a(r,n){var o,i,s,t,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,i&&(s=2&e[0]?i.return:e[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return u.label++,{value:e[1],done:!1};case 5:u.label++,i=e[1],e=[0];continue;case 7:e=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){u=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){u.label=e[1];break}if(6===e[0]&&u.label<s[1]){u.label=s[1],s=e;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(e);break}s[2]&&u.ops.pop(),u.trys.pop();continue}e=n.call(r,u)}catch(t){e=[6,t],i=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function f(t,e){return void 0===t&&(t=[]),void 0===e&&(e=50),new n(t,e)}var n=(e.prototype.resolve=function(r){var n=this;return s.createIOPromise(function(t,e){setTimeout(function(){return t(r)},n.delay)})},e.prototype.reject=function(r){var n=this;return s.createIOPromise(function(t,e){setTimeout(function(){return e(r)},n.delay)})},e.prototype.generateId=function(t){var e=Number(t);return isNaN(e)||(this.index[0]=Math.max(this.index[0],e)),t||String(this.index[0]++)},e.prototype.create=function(t,e){var r=t.id=this.generateId(t.id);return this.index.push(r),this.items[r]=t,this.resolve({id:r})},e.prototype.update=function(t,e,r){return this.items[t]=e,this.resolve({})},e.prototype.read=function(t,e){var r=this.items[t];return r?this.resolve(r):this.reject("Not found")},e.prototype.destroy=function(e,t){return this.items[e]?(delete this.items[e],this.index=this.index.filter(function(t){return t!==e}),this.resolve({})):this.reject("Not found")},e.prototype.list=function(t){var e=this;return this.resolve(this.index.slice(1).map(function(t){return e.items[t]}))},e.prototype.subscribe=function(t){},e.prototype.unsubscribe=function(t){},e);function e(t,e){this.delay=e,this.index=[0],this.items={};for(var r=0,n=t;r<n.length;r++){var o=n[r];this.create(o,{})}}function o(t,e){return new i(t,e)}var i=(h.prototype.create=function(t,e,r){var n=this.collectionUrl(r,e);return this.memoryIO?this.simulateIO("create","POST",n,arguments):this.request("POST",n,e,t)},h.prototype.update=function(t,e,r,n){var o=this.objectUrl(n,t,r);return this.memoryIO?this.simulateIO("update","PUT",o,arguments):this.request("PUT",o,r,e)},h.prototype.read=function(t,e,r){var n=this.objectUrl(r,t,e);return this.memoryIO?this.simulateIO("read","GET",n,arguments):this.request("GET",n,e)},h.prototype.destroy=function(t,e,r){var n=this.objectUrl(r,t,e);return this.memoryIO?this.simulateIO("destroy","DELETE",n,arguments):this.request("DELETE",n,e)},h.prototype.list=function(t,e){var r=this.collectionUrl(e,t);return this.memoryIO?this.simulateIO("list","GET",r,arguments):this.request("GET",r,t)},h.prototype.subscribe=function(t){},h.prototype.unsubscribe=function(t){},h.prototype.simulateIO=function(e,r,n,o){return p(this,void 0,void 0,function(){return a(this,function(t){return s.log(s.isProduction?"error":"info","Type-R:SimulatedIO",r+" "+n),[2,this.memoryIO[e].apply(this.memoryIO,o)]})})},h.prototype.objectUrl=function(t,e,r){return void 0===r&&(r={}),l.from(this.url,t,r).modelId(t).params(r.params).toString()},h.prototype.collectionUrl=function(t,e){return void 0===e&&(e={}),l.from(this.url,t,e).params(e.params).toString()},h.prototype.buildRequestOptions=function(t,e,r){var n=u(u(u({},h.defaultFetchOptions),this.fetchOptions),e),o=n.headers,i=c(n,["headers"]),s=u({method:t,headers:u({"Content-Type":"application/json"},o)},i);return r&&(s.body=JSON.stringify(r)),s},h.prototype.request=function(t,e,r,n){var o=r.options;return fetch(e,this.buildRequestOptions(t,o,n)).then(function(t){if(t.ok)return t.json();throw new Error(t.statusText)})},h.defaultFetchOptions={cache:"no-cache",credentials:"same-origin",mode:"cors",redirect:"error"},h);function h(t,e){void 0===e&&(e={});var r=e.mockData,n=e.simulateDelay,o=void 0===n?1e3:n,i=c(e,["mockData","simulateDelay"]);this.url=t,this.fetchOptions=i,this.memoryIO=r&&!s.isProduction?f(r,o):null,r&&s.isProduction&&s.log("error","Type-R:RestfulIO","Mock data is used in production for "+t)}var l=(d.from=function(t,e,r){void 0===r&&(r={});var n="function"==typeof t?t(r,e instanceof s.Model?e:null):t;if(0===n.indexOf("./")){var o=e.getOwner();n=y(o.getEndpoint().objectUrl(o,r))+"/"+n.substr(2)}return new d(n)},d.prototype.modelId=function(t){return t instanceof s.Model&&!t.isNew()?this.append(t.id):this},d.prototype.append=function(t){return new d(y(this.url)+"/"+t)},d.prototype.params=function(e){var r=encodeURIComponent;return e?new d(this.url+"?"+Object.keys(e).map(function(t){return r(t)+"="+r(e[t])}).join("&")):this},d.prototype.toString=function(){return this.url},d);function d(t){this.url=t}function y(t){return"/"===t.charAt(t.length-1)?t.substr(0,t.length-1):t}function v(t){throw new ReferenceError("Method "+t+" is not supported. modelFetchIO supports only model.fetch().")}var m,b,O,g=(r(m=I,b=O=i),void(m.prototype=null===b?Object.create(b):(w.prototype=b.prototype,new w)),I.prototype.list=function(){return p(this,void 0,void 0,function(){return a(this,function(t){return v("collection.fetch()"),[2]})})},I.prototype.destroy=function(){return p(this,void 0,void 0,function(){return a(this,function(t){return v("model.destroy()"),[2]})})},I.prototype.create=function(){return p(this,void 0,void 0,function(){return a(this,function(t){return v("model.save()"),[2]})})},I.prototype.update=function(){return p(this,void 0,void 0,function(){return a(this,function(t){return v("model.save()"),[2]})})},I.prototype.read=function(t,r,n){return p(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return e=this.collectionUrl(n,r),this.memoryIO?(s.log(s.isProduction?"error":"info","Type-R:SimulatedIO","GET "+e),[4,this.memoryIO.list(r)]):[3,2];case 1:return[2,t.sent()[0]];case 2:return[2,this.request(this.method,e,r)]}})})},I=function(t,e,r,n){var o,i=arguments.length,s=i<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,n);else for(var u=t.length-1;0<=u;u--)(o=t[u])&&(s=(i<3?o(s):3<i?o(e,r,s):o(e,r))||s);return 3<i&&s&&Object.defineProperty(e,r,s),s}([s.define],I));function w(){this.constructor=m}function I(t,e,r){void 0===r&&(r={});var n=r.mockData,o=c(r,["mockData"]),i=O.call(this,"",n?u({mockData:[n]},o):o)||this;return i.method=t,i.url=e,i}var j={parse:!0,strict:!0};var x=(Object.defineProperty(S.prototype,"endpoint",{get:function(){return this.Record.prototype._endpoint},enumerable:!0,configurable:!0}),S.prototype.subscribe=function(e,r){return p(this,void 0,void 0,function(){return a(this,function(t){return[2,this.endpoint.subscribe(e,r)]})})},S.prototype.unsubscribe=function(t,e){this.endpoint.unsubscribe(t,e)},S.prototype.list=function(r){return p(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return[4,(e=new this.Record.Collection).fetch(r)];case 1:return t.sent(),[2,e.toJSON()]}})})},S.prototype.update=function(n,o,i){return p(this,void 0,void 0,function(){var e,r;return a(this,function(t){switch(t.label){case 0:return o.id=n,[4,(e=this.Record.from(o,j)).save(i)];case 1:return t.sent(),E(r={_cas:e._cas},e,this.options.updateAttrs),[2,r]}})})},S.prototype.create=function(n,o){return p(this,void 0,void 0,function(){var e,r;return a(this,function(t){switch(t.label){case 0:return[4,(e=this.Record.from(n,j)).save(o)];case 1:return t.sent(),E(r={id:e.id,_cas:e._cas,_type:e._type},e,this.options.createAttrs),[2,r]}})})},S.prototype.read=function(r,n){return p(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return[4,(e=new this.Record({id:r})).fetch(n)];case 1:return t.sent(),[2,e.toJSON()]}})})},S.prototype.destroy=function(e,r){return p(this,void 0,void 0,function(){return a(this,function(t){return[2,this.endpoint.destroy(e,r)]})})},S);function S(t,e){var r=this;void 0===e&&(e={}),this.options={},this.Record=t,e.createAttrs&&(this.options.createAttrs=e.createAttrs.split(/\s+/)),e.updateAttrs&&(this.options.updateAttrs=e.updateAttrs.split(/\s+/));var n=Object.getPrototypeOf(this.endpoint);Object.keys(n).forEach(function(t){r[t]||"function"!=typeof n[t]||(r[t]=function(){return n[t].apply(this.endpoint,arguments)})})}function E(t,e,r){if(r)for(var n=e.toJSON(),o=0,i=r;o<i.length;o++){var s=i[o];t[s]=n[s]}}var P=(T.prototype.resolve=function(r){return s.createIOPromise(function(t,e){setTimeout(function(){t(r)},0)})},T.prototype.reject=function(r){return s.createIOPromise(function(t,e){setTimeout(function(){return e(r)},0)})},T.prototype.create=function(t,e){var r=this.index;return r.push(t.id=String(r[0]++)),this.index=r,this.set(t),this.resolve({id:t.id})},T.prototype.set=function(t){localStorage.setItem(this.key+"#"+t.id,JSON.stringify(t))},T.prototype.get=function(t){return JSON.parse(localStorage.getItem(this.key+"#"+t))},T.prototype.update=function(t,e,r){return e.id=t,this.set(e),this.resolve({})},T.prototype.read=function(t,e){var r=this.get(t);return r?this.resolve(r):this.reject("Not found")},T.prototype.destroy=function(e,t){return this.get(e)?(localStorage.removeItem(this.key+"#"+e),this.index=this.index.filter(function(t){return t!==e}),this.resolve({})):this.reject("Not found")},Object.defineProperty(T.prototype,"index",{get:function(){return JSON.parse(localStorage.getItem(this.key))||[0]},set:function(t){localStorage.setItem(this.key,JSON.stringify(t))},enumerable:!0,configurable:!0}),T.prototype.list=function(t){var e=this;return this.index,this.resolve(this.index.slice(1).map(function(t){return e.get(t)}))},T.prototype.subscribe=function(t){},T.prototype.unsubscribe=function(t){},T);function T(t){this.key=t}var k=(R.prototype.create=function(t,e){throw new Error("Method is not supported.")},R.prototype.update=function(t,e,r){throw new Error("Method is not supported.")},R.prototype.read=function(t,e,r){var n=r.keys().filter(function(t){return r[t]&&r[t].fetch}).map(function(t){return r[t].fetch(e)}),o=Promise.all(n).then(function(){});return o.abort=function(){n.forEach(function(t){return t.abort&&t.abort()})},o},R.prototype.destroy=function(t,e){throw new Error("Method is not supported.")},R.prototype.list=function(t){throw new Error("Method is not supported.")},R.prototype.subscribe=function(t){},R.prototype.unsubscribe=function(t){},R);function R(){}t.AttributesEndpoint=k,t.LocalStorageEndpoint=P,t.MemoryEndpoint=n,t.ProxyEndpoint=x,t.RestfulEndpoint=i,t.UrlBuilder=l,t.attributesIO=function(){return new k},t.create=o,t.fetchModelIO=function(t,e,r){return new g(t,e,r)},t.localStorageIO=function(t){return new P(t)},t.memoryIO=f,t.proxyIO=function(t,e){return void 0===e&&(e={}),new x(t,e)},t.restfulIO=o,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
