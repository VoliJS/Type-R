!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("react"),require("@type-r/models")):"function"==typeof define&&define.amd?define(["exports","react","@type-r/models"],e):e((t=t||self).Nested={},t.React,t.Nested)}(this,function(r,c,s){"use strict";var f="default"in c?c.default:c;var t=[];function o(){return c.useReducer(e,null)[1]}function e(t,e){return e._changeToken}var n=c.createContext(null);function i(){return c.useContext(n)}var u=g(function(t){return new v(new t)});function a(t){var e=u(t.constructor);return c.useEffect(function(){e.assignFrom(t)},[t._changeToken]),e}function p(n,r){void 0===r&&(r=1e3);var o=a(n);return c.useEffect(function(){var t;function e(){t&&clearTimeout(t),t=setTimeout(function(){n.assignFrom(o),t=null},r)}return o.on("change",e),function(){o.off("change",e),t&&(clearTimeout(t),n.assignFrom(o))}},[]),o}u.copy=a,u.delayChanges=p;function l(t){return new v(t.createSubset([]))}var h={of:g(function(t){return new v(new(s.Collection.of(t)))}),ofRefs:g(function(t){return new v(new(s.Collection.ofRefs(t)))}),subsetOf:function(e){var t=c.useReducer(d,e,l),n=t[0],r=t[1];return c.useEffect(function(){var t=n.value;t.resolvedWith||t.resolve(e)},[Boolean(e.models.length)]),c.useEffect(function(){return n._onChildrenChange=function(t){return r(t)},function(){return n.value.dispose()}},k),n.value}},v=(y.prototype.getStore=function(){return this.store||this.value._defaultStore},y.prototype.clone=function(){var t=new y(this.value);return t._onChildrenChange=this._onChildrenChange,t},y);function y(t){this.value=t,this._onChildrenChange=void 0,this.store=null,this._changeToken=t._changeToken,t._owner=this,t._ownerKey||(t._ownerKey="reactState")}function d(t){return t._changeToken===t.value._changeToken?t:t.clone()}function g(u){return function(t){var e=c.useReducer(d,t,u),n=e[0],r=e[1],o=i();return o&&(n.store=o),c.useEffect(function(){return n._onChildrenChange=function(t){return r(t)},function(){return n.value.dispose()}},k),n.value}}var k=[],_=function(t,e){return(_=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function b(t,e){function n(){this.constructor=t}_(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var m=function(){return(m=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)},w=Array.prototype,O=Object.prototype;function C(t){if(t&&"object"==typeof t)switch(Object.getPrototypeOf(t)){case w:return S;case O:return P}return j}var L,j={clone:function(t){return t},map:function(t,e){return[]},remove:function(t){return t}},P={map:function(t,e){var n=[],r=t.value;for(var o in r)if(r.hasOwnProperty(o)){var u=e(t.at(o),o);void 0===u||n.push(u)}return n},remove:function(t,e){return delete t[e],t},clone:function(t){return m({},t)}},S={clone:function(t){return t.slice()},remove:function(t,e){return t.splice(e,1),t},map:function(t,e){for(var n=t.value.length,r=Array(n),o=0,u=0;o<n;o++){var i=e(t.at(o),o);void 0===i||(r[u++]=i)}return r.length===u||(r.length=u),r}};function E(t){this.value=t,this.error=void 0}r.Linked=(Object.defineProperty(E.prototype,"current",{get:function(){return this.value},set:function(t){this.set(t)},enumerable:!0,configurable:!0}),Object.defineProperty(E.prototype,"_changeToken",{get:function(){return this.value},enumerable:!0,configurable:!0}),E.prototype.onChange=function(e){var n=this;return new $(this,function(t){e(t),n.set(t)})},E.prototype.pipe=function(n){var r=this;return new $(this,function(t){var e=n(t,r.value);void 0===e||r.set(e)})},Object.defineProperty(E.prototype,"props",{get:function(){var e=this;return"boolean"==typeof this.value?{checked:this.value,onChange:function(t){return e.set(Boolean(t.target.checked))}}:{value:this.value,onChange:function(t){return e.set(t.target.value)}}},enumerable:!0,configurable:!0}),E.prototype.update=function(t,e){var n=t(this.clone(),e);void 0===n||this.set(n)},E.prototype.action=function(e){var n=this;return function(t){return n.update(e,t)}},E.prototype.equals=function(t){return new B(this,t)},Object.defineProperty(E.prototype,"true",{get:function(){var t=this;return function(){return t.set(!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(E.prototype,"false",{get:function(){var t=this;return function(){return t.set(!1)}},enumerable:!0,configurable:!0}),Object.defineProperty(E.prototype,"null",{get:function(){var t=this;return function(){return t.set(null)}},enumerable:!0,configurable:!0}),Object.defineProperty(E.prototype,"isTruthy",{get:function(){return!!this.value||void 0},enumerable:!0,configurable:!0}),E.prototype.enabled=function(t){return new N(this,t||"")},E.prototype.contains=function(t){return new U(this,t)},E.prototype.push=function(){var t=S.clone(this.value);Array.prototype.push.apply(t,arguments),this.set(t)},E.prototype.unshift=function(){var t=S.clone(this.value);Array.prototype.unshift.apply(t,arguments),this.set(t)},E.prototype.splice=function(){var t=S.clone(this.value);Array.prototype.splice.apply(t,arguments),this.set(t)},E.prototype.map=function(t){return C(this.value).map(this,t)},E.prototype.removeAt=function(t){var e=this.value,n=C(e);this.set(n.remove(n.clone(e),t))},E.prototype.at=function(t){return new W(this,t)},E.prototype.clone=function(){var t=this.value;return C(t).clone(t)},E.prototype.pick=function(){for(var t={},e=arguments.length?arguments:Object.keys(this.value),n=0;n<e.length;n++){var r=e[n];t[r]=new W(this,r)}return t},Object.defineProperty(E.prototype,"$",{get:function(){if(!this._value$){var t=this._value$={},e=this.value;for(var n in e)e.hasOwnProperty(n)&&(t[n]=new W(this,n))}return this._value$},enumerable:!0,configurable:!0}),E.prototype.check=function(t,e){return this.error||t(this.value)||(this.error=e||t.error||K),this},E),(L=r.Linked||(r.Linked={})).value=function(t,e){return new A(t,e)},L.mutable=function(n){return new A(n,function(t){for(var e in t)t.hasOwnProperty(e)&&(n[e]=t[e])})},L.getValues=function(t){return G(t,"value")},L.getErrors=function(t){return G(t,"error")},L.hasErrors=function(t){for(var e in t)if(t.hasOwnProperty(e)&&t[e].error)return!0;return!1},L.setValues=function(t,e){if(e)for(var n in t){var r=Q(n);if(e.hasOwnProperty(r)){var o=e[r];void 0===o||t[n].set(o)}}};var T,A=(b(R,T=r.Linked),R.prototype.set=function(t){},R);function R(t,e){var n=T.call(this,t)||this;return n.set=e,n}var V,$=(b(x,V=r.Linked),x.prototype.set=function(t){},x);function x(t,e){var n=V.call(this,t.value)||this;n.set=e;var r=t.error;return r&&(n.error=r),n}var F,B=(b(I,F=r.Linked),I.prototype.set=function(t){this.parent.set(t?this.truthyValue:null)},I);function I(t,e){var n=F.call(this,t.value===e)||this;return n.parent=t,n.truthyValue=e,n}var M,N=(b(q,M=r.Linked),q.prototype.set=function(t){this.parent.set(t?this.defaultValue:null)},q);function q(t,e){var n=M.call(this,null!=t.value)||this;return n.parent=t,n.defaultValue=e,n}var D,U=(b(H,D=r.Linked),H.prototype.set=function(t){var e=this,n=Boolean(t);if(this.value!==n){var r=this.parent.value,o=t?r.concat(this.element):r.filter(function(t){return t!==e.element});this.parent.set(o)}},H);function H(t,e){var n=D.call(this,0<=t.value.indexOf(e))||this;return n.parent=t,n.element=e,n}var J,K="Invalid value",W=(b(z,J=r.Linked),z.prototype.remove=function(){this.parent.removeAt(this.key)},z.prototype.update=function(r,o){var u=this.key;this.parent.update(function(t){var e=t[u],n=r(C(e).clone(e),o);if(void 0!==n)return t[u]=n,t})},z.prototype.set=function(e){var n=this.key;this.parent.update(function(t){if(t[n]!==e)return t[n]=e,t})},z);function z(t,e){var n=J.call(this,t.value[e])||this;return n.parent=t,n.key=e,n}function G(t,e){var n={};for(var r in t)if(t.hasOwnProperty(r)){var o=t[r][e];void 0!==o&&(n[Q(r)]=o)}return n}function Q(t){return"$"===t[0]?t.slice(1):t}var X=function(t,e){return(X=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function Y(t,e){function n(){this.constructor=t}X(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var Z,tt=(Y(et,Z=c.Component),et.prototype.linkAt=function(t){return this.$at(t)},et.prototype.$at=function(t){var e=this.state[t],n=this.links||(this.links={}),r=n[t];return r&&r.value===e?r:n[t]=new rt(this,t,e)},et.prototype.linkAll=function(){return this.state$.apply(this,arguments)},et.prototype.state$=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=this.state,r=this.links||(this.links={}),o=0,u=t.length?t:Object.keys(n);o<u.length;o++){var i=u[o],a=n[i],c=r[i];c&&c.value===a||(r[i]=new rt(this,i,a))}return r},et);function et(){var t=null!==Z&&Z.apply(this,arguments)||this;return t.links=null,t}var nt,rt=(Y(ot,nt=r.Linked),ot.prototype.set=function(t){var e={};e[this.key]=t,this.component.setState(e)},ot);function ot(t,e,n){var r=nt.call(this,n)||this;return r.component=t,r.key=e,r}var ut,it=(Y(at,ut=r.Linked),at.prototype.set=function(t){},at.prototype.update=function(r,o){this.set(function(t){var e=C(t).clone(t),n=r(e,o);return void 0===n?t:n})},at);function at(t,e){var n=ut.call(this,t)||this;return n.set=e,n}function ct(t){var e=c.useState(t),n=e[0],r=e[1];return new it(n,r)}function st(t){var e=c.useState(t),n=e[0],r=e[1],o=ft();return new it(n,function(t){return o.current&&r(t)})}function ft(){var t=c.useRef(!0);return c.useEffect(function(){return function(){return t.current=!1}},[]),t}function pt(t){var e=t instanceof r.Linked?t.value:t,n=ct(e);return c.useEffect(function(){return n.set(e)},[e]),n}function lt(t){var e=t instanceof r.Linked?t.value:t,n=st(e);return c.useEffect(function(){return n.set(e)},[e]),n}function ht(t){return t&&void 0!==t._changeToken?t._changeToken:t}var vt=function(t,e){return(vt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};var yt=function(){return(yt=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function dt(t,e){return t.prototype instanceof s.Transactional?"props."+e+" && props."+e+"._changeToken":t===Date?"props."+e+" && props."+e+".getTime()":t===s.Linked?"props."+e+" && props."+e+".value":"props."+e}r.Link=r.Linked,r.LinkedComponent=tt,r.PropValueLink=W,r.StateLink=rt,r.StoreContext=n,r.arrayHelpers=S,r.helpers=C,r.objectHelpers=P,r.pureRenderProps=function(t,e){var n,r=s.attributes(t).prototype._attributes,o=Object.keys(t),u=new Function("props","\n        return [\n            "+o.map(function(t){return dt(r[t].type,t)}).join(", ")+"\n        ]\n    "),i=new Function("props","vector","\n        return "+o.map(function(t,e){return"vector["+e+"] !== ( "+dt(r[t].type,t)+" )"}).join(" || ")+";\n    ");function a(t){var e=n.call(this,t)||this;return e._vector=u(e.props),e}return function(t,e){function n(){this.constructor=t}vt(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}(a,n=c.Component),a.prototype.shouldComponentUpdate=function(t){return i(t,this._vector)},a.prototype.componentDidUpdate=function(){this._vector=u(this.props)},a.prototype.render=function(){return f.createElement(e,yt({},this.props))},a},r.useBoundLink=pt,r.useChanges=function(e){var n=o();c.useEffect(function(){function t(t){n(t)}return e.onChanges(t),function(){return e.offChanges(t)}},t)},r.useCollection=h,r.useDelayChanges=p,r.useEvent=function(t,e,n){c.useEffect(function(){return t.on(e,n),function(){t.off(e,n)}},[])},r.useForceUpdate=o,r.useIO=function(t,e){void 0===e&&(e=[]);var r=st(null);c.useEffect(function(){r.set(function(t){var e=t||[0,null];return[e[0]+1,e[1]]}),t().then(function(){return r.set(function(t){var e=t[0];t[1];return[e-1,null]})}).catch(function(n){return r.set(function(t){var e=t[0];t[1];return[e-1,n]})})},e);var n=r.value;return null!==n&&!n[0]&&(n[1]||!0)},r.useIsMountedRef=ft,r.useLink=ct,r.useLinked=ct,r.useLocalStorage=function(e,t){var n=c.useRef();n.current=t,c.useEffect(function(){var t=JSON.parse(localStorage.getItem(e)||"{}");return r.Linked.setValues(n.current,t),function(){var t=r.Linked.getValues(n.current);localStorage.setItem(e,JSON.stringify(t))}},[])},r.useModel=u,r.useModelCopy=a,r.useSafeBoundLink=lt,r.useSafeLink=st,r.useSafeLinked=st,r.useSafeSyncLinked=lt,r.useStore=i,r.useSyncLinked=pt,r.whenChanged=function(t,e,n,r){var o=arguments.length;switch(o){case 1:return[ht(t)];case 2:return[ht(t),ht(e)];case 3:return[ht(t),ht(e),ht(n)];default:for(var u=[ht(t),ht(e),ht(n),ht(r)],i=4;i<o;i++)u.push(ht(arguments[i]));return u}},Object.defineProperty(r,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
