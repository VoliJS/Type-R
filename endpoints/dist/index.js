!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@type-r/models")):"function"==typeof define&&define.amd?define(["exports","@type-r/models"],e):e((t=t||self).restfulIO={},t.Nested)}(this,function(t,s){"use strict";var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var u=function(){return(u=Object.assign||function(t){for(var e,r=1,o=arguments.length;r<o;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function c(t,e){var r={};for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.indexOf(o)<0&&(r[o]=t[o]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(t);n<o.length;n++)e.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(t,o[n])&&(r[o[n]]=t[o[n]])}return r}function a(i,s,u,c){return new(u=u||Promise)(function(t,e){function r(t){try{n(c.next(t))}catch(t){e(t)}}function o(t){try{n(c.throw(t))}catch(t){e(t)}}function n(e){e.done?t(e.value):new u(function(t){t(e.value)}).then(r,o)}n((c=c.apply(i,s||[])).next())})}function p(r,o){var n,i,s,t,u={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,i&&(s=2&e[0]?i.return:e[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return u.label++,{value:e[1],done:!1};case 5:u.label++,i=e[1],e=[0];continue;case 7:e=u.ops.pop(),u.trys.pop();continue;default:if(!(s=0<(s=u.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){u=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){u.label=e[1];break}if(6===e[0]&&u.label<s[1]){u.label=s[1],s=e;break}if(s&&u.label<s[2]){u.label=s[2],u.ops.push(e);break}s[2]&&u.ops.pop(),u.trys.pop();continue}e=o.call(r,u)}catch(t){e=[6,t],i=0}finally{n=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function f(t,e){return void 0===t&&(t=[]),void 0===e&&(e=50),new o(t,e)}var o=(e.prototype.resolve=function(r){var o=this;return s.createIOPromise(function(t,e){setTimeout(function(){return t(r)},o.delay)})},e.prototype.reject=function(r){var o=this;return s.createIOPromise(function(t,e){setTimeout(function(){return e(r)},o.delay)})},e.prototype.generateId=function(t){var e=Number(t);return isNaN(e)||(this.index[0]=Math.max(this.index[0],e)),t||String(this.index[0]++)},e.prototype.create=function(t,e){var r=t.id=this.generateId(t.id);return this.index.push(r),this.items[r]=t,this.resolve({id:r})},e.prototype.update=function(t,e,r){return this.items[t]=e,this.resolve({})},e.prototype.read=function(t,e){var r=this.items[t];return r?this.resolve(r):this.reject("Not found")},e.prototype.destroy=function(e,t){return this.items[e]?(delete this.items[e],this.index=this.index.filter(function(t){return t!==e}),this.resolve({})):this.reject("Not found")},e.prototype.list=function(t){var e=this;return this.resolve(this.index.slice(1).map(function(t){return e.items[t]}))},e.prototype.subscribe=function(t){},e.prototype.unsubscribe=function(t){},e);function e(t,e){this.delay=e,this.index=[0],this.items={};for(var r=0,o=t;r<o.length;r++){var n=o[r];this.create(n,{})}}function n(t,e){return new i(t,e)}var i=(h.prototype.create=function(t,e,r){var o=this.collectionUrl(r,e);return this.memoryIO?this.simulateIO("create","POST",o,arguments):this.request("POST",o,e,t)},h.prototype.update=function(t,e,r,o){var n=this.objectUrl(o,t,r);return this.memoryIO?this.simulateIO("update","PUT",n,arguments):this.request("PUT",n,r,e)},h.prototype.read=function(t,e,r){var o=this.objectUrl(r,t,e);return this.memoryIO?this.simulateIO("read","GET",o,arguments):this.request("GET",o,e)},h.prototype.destroy=function(t,e,r){var o=this.objectUrl(r,t,e);return this.memoryIO?this.simulateIO("destroy","DELETE",o,arguments):this.request("DELETE",o,e)},h.prototype.list=function(t,e){var r=this.collectionUrl(e,t);return this.memoryIO?this.simulateIO("list","GET",r,arguments):this.request("GET",r,t)},h.prototype.subscribe=function(t){},h.prototype.unsubscribe=function(t){},h.prototype.simulateIO=function(e,r,o,n){return a(this,void 0,void 0,function(){return p(this,function(t){return s.log(s.isProduction?"error":"info","Type-R:SimulatedIO",r+" "+o),[2,this.memoryIO[e].apply(this.memoryIO,n)]})})},h.prototype.isRelativeUrl=function(t){return 0===t.indexOf("./")},h.prototype.removeTrailingSlash=function(t){return"/"===t.charAt(t.length-1)?t.substr(0,t.length-1):t},h.prototype.getRootUrl=function(t){var e=this.url;if(this.isRelativeUrl(e)){var r=t.getOwner(),o=r.getEndpoint().getUrl(r);return this.removeTrailingSlash(o)+"/"+e.substr(2)}return e},h.prototype.getUrl=function(t){var e=this.getRootUrl(t);return t.isNew()?e:this.removeTrailingSlash(e)+"/"+t.id},h.prototype.objectUrl=function(t,e,r){return l(this.getUrl(t),r.params)},h.prototype.collectionUrl=function(t,e){return l(this.getRootUrl(t),e.params)},h.prototype.buildRequestOptions=function(t,e,r){var o=u({},h.defaultFetchOptions,this.fetchOptions,e),n=o.headers,i=c(o,["headers"]),s=u({method:t,headers:u({"Content-Type":"application/json"},n)},i);return r&&(s.body=JSON.stringify(r)),s},h.prototype.request=function(t,e,r,o){var n=r.options;return fetch(e,this.buildRequestOptions(t,n,o)).then(function(t){if(t.ok)return t.json();throw new Error(t.statusText)})},h.defaultFetchOptions={cache:"no-cache",credentials:"same-origin",mode:"cors",redirect:"error"},h);function h(t,e){void 0===e&&(e={});var r=e.mockData,o=e.simulateDelay,n=void 0===o?1e3:o,i=c(e,["mockData","simulateDelay"]);this.url=t,this.fetchOptions=i,this.memoryIO=r&&!s.isProduction?f(r,n):null,r&&s.isProduction&&s.log("error","Type-R:RestfulIO","Mock data is used in production for "+t)}function l(t,e){var r=encodeURIComponent;return e?t+"?"+Object.keys(e).map(function(t){return r(t)+"="+r(e[t])}).join("&"):t}function d(t){throw new ReferenceError("Method "+t+" is not supported. modelFetchIO supports only model.fetch().")}var y,v,m,b=(r(y=g,v=m=i),void(y.prototype=null===v?Object.create(v):(O.prototype=v.prototype,new O)),g.prototype.list=function(){return a(this,void 0,void 0,function(){return p(this,function(t){return d("collection.fetch()"),[2]})})},g.prototype.destroy=function(){return a(this,void 0,void 0,function(){return p(this,function(t){return d("model.destroy()"),[2]})})},g.prototype.create=function(){return a(this,void 0,void 0,function(){return p(this,function(t){return d("model.save()"),[2]})})},g.prototype.update=function(){return a(this,void 0,void 0,function(){return p(this,function(t){return d("model.save()"),[2]})})},g.prototype.read=function(t,e,r){return a(this,void 0,void 0,function(){return p(this,function(t){switch(t.label){case 0:return this.url=this.constructUrl(e.params,r),this.memoryIO?(s.log(s.isProduction?"error":"info","Type-R:SimulatedIO","GET "+this.url),[4,this.memoryIO.list(e)]):[3,2];case 1:return[2,t.sent()[0]];case 2:return[2,this.request(this.method,this.getRootUrl(r),e)]}})})},g=function(t,e,r,o){var n,i=arguments.length,s=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,r,o);else for(var u=t.length-1;0<=u;u--)(n=t[u])&&(s=(i<3?n(s):3<i?n(e,r,s):n(e,r))||s);return 3<i&&s&&Object.defineProperty(e,r,s),s}([s.define],g));function O(){this.constructor=y}function g(t,e,r){void 0===r&&(r={});var o=r.mockData,n=c(r,["mockData"]),i=m.call(this,"",o?u({mockData:[o]},n):n)||this;return i.method=t,i.constructUrl=e,i}var w={parse:!0,strict:!0};var I=(Object.defineProperty(j.prototype,"endpoint",{get:function(){return this.Record.prototype._endpoint},enumerable:!0,configurable:!0}),j.prototype.subscribe=function(e,r){return a(this,void 0,void 0,function(){return p(this,function(t){return[2,this.endpoint.subscribe(e,r)]})})},j.prototype.unsubscribe=function(t,e){this.endpoint.unsubscribe(t,e)},j.prototype.list=function(r){return a(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return[4,(e=new this.Record.Collection).fetch(r)];case 1:return t.sent(),[2,e.toJSON()]}})})},j.prototype.update=function(o,n,i){return a(this,void 0,void 0,function(){var e,r;return p(this,function(t){switch(t.label){case 0:return n.id=o,[4,(e=this.Record.from(n,w)).save(i)];case 1:return t.sent(),x(r={_cas:e._cas},e,this.options.updateAttrs),[2,r]}})})},j.prototype.create=function(o,n){return a(this,void 0,void 0,function(){var e,r;return p(this,function(t){switch(t.label){case 0:return[4,(e=this.Record.from(o,w)).save(n)];case 1:return t.sent(),x(r={id:e.id,_cas:e._cas,_type:e._type},e,this.options.createAttrs),[2,r]}})})},j.prototype.read=function(r,o){return a(this,void 0,void 0,function(){var e;return p(this,function(t){switch(t.label){case 0:return[4,(e=new this.Record({id:r})).fetch(o)];case 1:return t.sent(),[2,e.toJSON()]}})})},j.prototype.destroy=function(e,r){return a(this,void 0,void 0,function(){return p(this,function(t){return[2,this.endpoint.destroy(e,r)]})})},j);function j(t,e){var r=this;void 0===e&&(e={}),this.options={},this.Record=t,e.createAttrs&&(this.options.createAttrs=e.createAttrs.split(/\s+/)),e.updateAttrs&&(this.options.updateAttrs=e.updateAttrs.split(/\s+/));var o=Object.getPrototypeOf(this.endpoint);Object.keys(o).forEach(function(t){r[t]||"function"!=typeof o[t]||(r[t]=function(){return o[t].apply(this.endpoint,arguments)})})}function x(t,e,r){if(r)for(var o=e.toJSON(),n=0,i=r;n<i.length;n++){var s=i[n];t[s]=o[s]}}var S=(E.prototype.resolve=function(r){return s.createIOPromise(function(t,e){setTimeout(function(){t(r)},0)})},E.prototype.reject=function(r){return s.createIOPromise(function(t,e){setTimeout(function(){return e(r)},0)})},E.prototype.create=function(t,e){var r=this.index;return r.push(t.id=String(r[0]++)),this.index=r,this.set(t),this.resolve({id:t.id})},E.prototype.set=function(t){localStorage.setItem(this.key+"#"+t.id,JSON.stringify(t))},E.prototype.get=function(t){return JSON.parse(localStorage.getItem(this.key+"#"+t))},E.prototype.update=function(t,e,r){return e.id=t,this.set(e),this.resolve({})},E.prototype.read=function(t,e){var r=this.get(t);return r?this.resolve(r):this.reject("Not found")},E.prototype.destroy=function(e,t){return this.get(e)?(localStorage.removeItem(this.key+"#"+e),this.index=this.index.filter(function(t){return t!==e}),this.resolve({})):this.reject("Not found")},Object.defineProperty(E.prototype,"index",{get:function(){return JSON.parse(localStorage.getItem(this.key))||[0]},set:function(t){localStorage.setItem(this.key,JSON.stringify(t))},enumerable:!0,configurable:!0}),E.prototype.list=function(t){var e=this;return this.index,this.resolve(this.index.slice(1).map(function(t){return e.get(t)}))},E.prototype.subscribe=function(t){},E.prototype.unsubscribe=function(t){},E);function E(t){this.key=t}var P=(R.prototype.create=function(t,e){throw new Error("Method is not supported.")},R.prototype.update=function(t,e,r){throw new Error("Method is not supported.")},R.prototype.read=function(t,e,r){var o=r.keys().filter(function(t){return r[t]&&r[t].fetch}).map(function(t){return r[t].fetch(e)}),n=Promise.all(o).then(function(){});return n.abort=function(){o.forEach(function(t){return t.abort&&t.abort()})},n},R.prototype.destroy=function(t,e){throw new Error("Method is not supported.")},R.prototype.list=function(t){throw new Error("Method is not supported.")},R.prototype.subscribe=function(t){},R.prototype.unsubscribe=function(t){},R);function R(){}t.AttributesEndpoint=P,t.LocalStorageEndpoint=S,t.MemoryEndpoint=o,t.ProxyEndpoint=I,t.RestfulEndpoint=i,t.attributesIO=function(){return new P},t.create=n,t.fetchModelIO=function(t,e,r){return new b(t,e,r)},t.localStorageIO=function(t){return new S(t)},t.memoryIO=f,t.proxyIO=function(t,e){return void 0===e&&(e={}),new I(t,e)},t.restfulIO=n,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=index.js.map
