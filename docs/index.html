<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Type-R 4.0 API Reference</title>

    <link rel="icon" href="images/logo-dark.png" />
    <link href="lib/stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="lib/stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <link href="lib/stylesheets/default.css" rel="stylesheet" type="text/css" />

    <style>
      .logo-section img {
        vertical-align: middle;
        margin: 15px;
        height: 48px;
      }

      .logo-section .logo-text {
        vertical-align: middle;
        color: white;
        display: inline-block;
      }

      .logo-section .logo-caption {
        font-size: 28px;
      }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script src="lib/javascripts/all.js" type="text/javascript"></script>

      <script>
        $(function() {
          var langs = [];
            langs.push("javascript");
          setupLanguages( langs );
        });
      </script>
  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <div class="logo-section">
        <img src="images/logo.png" />
        <div class="logo-text">
          <div class="logo-caption">Type-R 4.0</div>
          <div>universal state management</div>
        </div>
        
      </div>
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
                <li><a href="https://github.com/VoliJS/Type-R">GitHub repository</a></li>
                <li><a href="https://github.com/VoliJS/Type-R/issues">Report the bug</a></li>
                <li><a href="https://groups.google.com/forum/#!forum/volicon-open-source">Ask the question</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
        <div class="content">
          
<p><img src="docs/images/overview.png" alt="overview"></p>
<h1 id="type-r-model-framework">Type-R Model Framework</h1>
<p>Type-R is a serializable type system for JS and TS. Data structures you describe with Type-R models are automatically and with zero effort:</p>
<ul>
<li>serializable to and from JSON;</li>
<li>protected from improper assignments at run-time;</li>
<li>deeply observable.</li>
</ul>
<h2 id="features">Features</h2>
<p>Mapping of complex JS types to JSON (such as Date, classes, objects trees with cross-references) is automatic with Type-R which eliminates a possibility of programmer&#39;s mistakes and improves productivity. Less code to write means less things to unit test, less bugs to fix, and less code to read and understand when making changes.</p>
<p>Type-R models safeguard both frontend and backend from errors in JSON. Programmer&#39;s mistake on a frontend can&#39;t affect the JSON sent to the server. Wrong JSON received from the server will be validated, sanitized, and can&#39;t cause catastrophic failures on the frontend. Type-R guarantee that the data structures will retain the declared shape and it immediately reports improper assignments to the console.</p>
<p>There are virtually no point in unit-testing Type-R models as they are mostly declarative definitions. They are able to check the structural integrity themselves, and Type-R can be instructed to throw exceptions instead of console logging. It makes the unit tests of the data layer unnecessary, and greately reduces an effort when writing an integration test.</p>
<h2 id="react-integration">React integration</h2>
<p>Data structures defined with Type-R are deeply observable by default. They can be used to manage the state of React applications right out of box utilizing &quot;unidirectional data flow&quot; with no additional tooling. Type-R data structures support two-way data binding and attribute-level validation rules, making the a complex forms UI a trivial task. Normally, you don&#39;t change your UI code to add validation, just add the validation check to model&#39;s attributes.</p>
<h2 id="example">Example</h2>
<p>The main Type-R building block is the <code>Model</code> class with attributes types declaration which behaves as a regular JS class. Models and collections of models can be nested indefinitely to define data structures of arbitrary complexity.</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { define, Record, Collection } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-r/models'</span>
<span class="hljs-keyword">import</span> { restfulIO } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-r/endpoints'</span>

@define <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Record</span> </span>{
    <span class="hljs-keyword">static</span> attributes = {
        <span class="hljs-attr">name</span>  : <span class="hljs-string">''</span>,
        <span class="hljs-attr">email</span> : <span class="hljs-string">''</span>
    }
}

@define <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Message</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Record</span> </span>{
    <span class="hljs-keyword">static</span> endpoint = restfulIO( <span class="hljs-string">'/api/messages'</span>, {
        <span class="hljs-comment">// REST I/O is simulated when the mock data is present, that's how you start.</span>
        mockData : [ { <span class="hljs-attr">id</span> : <span class="hljs-number">0</span>, <span class="hljs-attr">createdAt</span> : <span class="hljs-string">"1999-07-25T03:33:29.687Z"</span>, <span class="hljs-attr">author</span> : {}, <span class="hljs-attr">to</span> : [] }]
    } );

    <span class="hljs-keyword">static</span> attributes = {
        <span class="hljs-attr">createdAt</span> : <span class="hljs-built_in">Date</span>,
        <span class="hljs-attr">author</span>  : User, <span class="hljs-comment">// aggregated User record.</span>
        to      : Collection.of( User ), <span class="hljs-comment">// aggregated collection of users</span>
        subject : <span class="hljs-string">''</span>,
        <span class="hljs-attr">body</span>    : <span class="hljs-string">''</span>
    }
}

<span class="hljs-keyword">const</span> messages = Collection.of( Message ).create();

<span class="hljs-keyword">await</span> messages.fetch({ <span class="hljs-attr">params</span> : { <span class="hljs-attr">page</span> : <span class="hljs-number">0</span> }});

<span class="hljs-keyword">const</span> msg = messages.first();
msg.author.name = <span class="hljs-string">'Alan Poe'</span>;
msg.subject = <span class="hljs-string">'Nevermore'</span>;

<span class="hljs-keyword">await</span> msg.save();
</code></pre>
<h2 id="api-reference-and-docs"><a href="https://volijs.github.io/Type-R/">API reference and docs</a></h2>
<h2 id="installation-and-requirements">Installation and requirements</h2>
<aside class="success">IE10+, Edge, Safari, Chrome, and Firefox are supported</aside>

<aside class="warning">IE9 and Opera may work but has not been tested. IE8 won't work.</aside>

<p>Install Type-R models and built-in set of I/O endpoints (restfulIO, localStorageIO, and memoryIO):</p>
<p><code>npm install @type-r/models @type-r/endpoints</code></p>
<p>Install React bindings:</p>
<p><code>npm install @type-r/react</code></p>
<p>Install extended data types (Email, URL, IP, Integer, Microsoft date, UNIX Timestamp date):</p>
<p><code>npm install @type-r/ext-types</code></p>
<h2 id="monorepository-packages-structure">Monorepository packages structure</h2>
<p>Core packages:</p>
<ul>
<li><code>models</code> - Type-R framework core.</li>
<li><code>endpoints</code> - Type-R endpoints enabling models and collections I/O API.</li>
<li><code>react</code> - Type-R React bindings.</li>
<li><p><code>ext-types</code> - Extended data types.</p>
</li>
<li><p><code>globals</code> - provides backward compatibility for apps written with Type-R v2.</p>
</li>
<li><p><code>mixture</code> - Events, Mixins, and log router. Used by <code>@type-r/models</code>.</p>
</li>
<li><code>tests</code> - private package containing all the unit tests.</li>
<li><code>examples/*</code> - example <code>@type-r/react</code> apps.</li>
</ul>
<h1 id="models">Models</h1>
<h2 id="defining-models">Defining models</h2>
<h3 id="static-attributes-"><code>static</code> attributes = { ... }</h3>
<h3 id="nested-model-definitions">Nested model definitions</h3>
<h1 id="transactional-collections-core-implementation">Transactional collections core implementation</h1>
<p>Collection implements two-phase commit transactions,
and core manipulation methods.</p>
<h2 id="folder-structure-and-dependencies">Folder structure and dependencies</h2>
<pre><code>       index.ts
     ↗    ↑     ↖ 
add.ts remove.ts <span class="hljs-keyword">set</span>.ts
     ↖    ↑     ↗
       commons.ts
          ↑
  ../model/index.ts



</code></pre><h1 id="normalized-data">Normalized data</h1>
<h2 id="stores">Stores</h2>
<h3 id="class-store"><code>class</code> Store</h3>
<h3 id="metatype-collection-subsetof-collection-modelclass-"><code>metatype</code> Collection.subsetOf( collection, ModelClass? )</h3>
<h3 id="metatype-model-memberof-collection-modelclass-"><code>metatype</code> Model.memberOf( collection, ModelClass? )</h3>
<h1 id="react-bindings">React bindings</h1>
<h2 id="local-component-state">Local component state</h2>
<h3 id="hook-usemodel-modelclass-"><code>hook</code> useModel( ModelClass )</h3>
<h3 id="hook-usecollection-of-modelclass-"><code>hook</code> useCollection.of( ModelClass )</h3>
<pre><code class="highlight javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">State</span> </span>= attributes({
    <span class="hljs-attr">counter</span> : <span class="hljs-number">0</span>
});

<span class="hljs-keyword">const</span> StatefulComponent = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> state = useModel( State <span class="hljs-comment">/* any model class */</span> );

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{</span> () =&gt;</span> state.counter++ }&gt;
            { state.counter }
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<pre><code class="highlight javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> </span>= attributes({
    <span class="hljs-attr">counter</span> : <span class="hljs-number">0</span>
});

<span class="hljs-keyword">const</span> StatefulComponent = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> counters = useCollection.of( Counter );

    <span class="hljs-keyword">const</span> selected = useCollection.subsetOf( counters );

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{ user.counter }<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{</span> () =&gt;</span> user.counter++ }&gt;Add<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h2 id="data-binding">Data binding</h2>
<h3 id="class-linked"><code>class</code> Linked</h3>
<h3 id="hook-uselinked-value-"><code>hook</code> useLinked( value )</h3>
<pre><code class="highlight javascript"><span class="hljs-keyword">const</span> StatefulDataBound = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-comment">// Obtain linked local state.</span>
    <span class="hljs-keyword">const</span> $name = useLinked( <span class="hljs-string">''</span> );

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> {<span class="hljs-attr">...</span>$<span class="hljs-attr">name.props</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    )
}
</span>
</code></pre>
<h3 id="model-">model.$</h3>
<pre><code class="highlight javascript">@define <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Book</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span> </span>{
    <span class="hljs-keyword">static</span> attributes = {
        <span class="hljs-attr">name</span> : <span class="hljs-string">''</span>,
        <span class="hljs-attr">author</span> : <span class="hljs-string">''</span>
    }
}

<span class="hljs-keyword">const</span> EditBook = <span class="hljs-function">(<span class="hljs-params">{ book }</span>) =&gt;</span> {
    <span class="hljs-comment">// Obtain linked model attributes.</span>
    <span class="hljs-keyword">const</span> { name, author } = book.$;

    <span class="hljs-keyword">return</span> (
        &lt;div&gt;
            &lt;input {...name.props} /&gt;
            &lt;input {...author.props} /&gt;
        &lt;/div&gt;
    )
}
</code></pre>
<h3 id="collection-includes-model-">collection.$includes( model )</h3>
<h3 id="static-linked-value-value-set-"><code>static</code> Linked.value( value, set )</h3>
<h2 id="normalized-data-and-stores">Normalized data and stores</h2>
<p><code>Store</code> is the subclass of <code>Model</code> used as a root to resolve id-references in &#39;normalized data structures&#39;, when 
the data is represented as a set of collections with items referencing each other by id. If you don&#39;t have normalized data structures, you don&#39;t need <code>Store</code>.</p>
<p>Attributes of types <code>Model.memberOf( &#39;store.someCollection&#39; )</code> and <code>Collection.subsetOf( &#39;store.someCollection&#39; )</code>
will resolve model ids to the models taken from <code>someCollection</code> belonging to the closest <code>Store</code> model. The closest
store is located as follows:</p>
<p>1) The first <code>Store</code> from the model&#39;s owners chain is taken first.
2) If there are no such a collection in it, the next <code>Store</code> class in ownership chain is taken.
3) If there are no stores left in the ownerhip chain, the <code>Store.global</code> is used.</p>
<p>From the particular model&#39;s view, there&#39;s a single <code>store</code> namespace which is defined by <code>Store.global</code> and
extended by upper stores in its ownership chain.</p>
<p>In <code>@type-r/react</code>, you can create the store as a local component state, and expose it down to the component subtree
so its children can opt to use this context store for id resolutions in their local state models.</p>
<p>That leads to a multi-tier store achitecture where the next tier store may override upper store collections and extend it with new collections.</p>
<ul>
<li>Tier 1. <code>Store.global</code> holds the state which is shared across all SPA pages.</li>
<li>Tier 2. Page component stores holds the state which is related to particular pages.</li>
<li>Tier 3. Particular components might add their local stores extending the namespace created by upper stores.</li>
</ul>
<p>Stores</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">const</span> X = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> state = useModel( State );
    useContextStore( state );
}
</code></pre>
<p>@type-r/react examples.</p>
<h1 id="mixture">Mixture</h1>
<h2 id="getting-started">Getting started</h2>
<p>Type-R Mixture is the toolkit combining React-style mixins, Backbone-style events, and minimal set of Underscore-style object manipulation functions.</p>
<p>Written in TypeScript, works with ES5, ES6, and TypeScript.</p>
<h3 id="installation">Installation</h3>
<p><code>npm install @type-r/mixture</code></p>
<h3 id="features">Features</h3>
<ul>
<li><code>Mixable</code>, React-style mixins.<ul>
<li>Fine-grained control over member merge rules.</li>
<li>Can mix both classes and plain objects.</li>
<li>Works with and without ES6 class decorators.</li>
</ul>
</li>
<li><code>Messenger</code>, synchronous events.<ul>
<li>Can be used as mixin and as a base class.</li>
<li>100% backward API compatibility with <a href="http://backbonejs.org/#Events">Backbone Events</a> (passes Backbone 1.2.x unit test)</li>
<li>Much faster than Backbone events.</li>
</ul>
</li>
<li><code>Logger</code>, thin but powerful logging abstraction build on top of <code>Messenger</code>. Defaults to the <code>console</code>.</li>
<li>Minimal set of speed-optimized underscore-style object manipulation tools (<code>assign</code>, <code>defaults</code>, <code>mapObject</code>, etc).</li>
</ul>
<h2 id="mixins">Mixins</h2>
<p>Both plain JS object and class constructor may be used as mixins. In the case of the class constructor, missing static members will copied over as well.</p>
<p>You need to import <code>mixins</code> decorator to use mixins:</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { mixins } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-r/mixture'</span>

...

@mixins( plainObject, MyClass, ... )
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">X</span> </span>{
    ...
}
</code></pre>
<h3 id="merge-rules-and-react-compatibility">Merge Rules and React Compatibility</h3>
<p>Mixture implements <em>configurable</em> merge rules, which allows to add standard React mixins functionality to the ES6 React Components.</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { Mixable } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-r/mixture'</span>

<span class="hljs-comment">// Make React.Component mixable...</span>
Mixable.mixTo( React.Component );

<span class="hljs-comment">// Define lifecycle methods merge rules...</span>
React.Component.mixinRules({
    <span class="hljs-attr">componentWillMount</span> : <span class="hljs-string">'reverse'</span>,
    <span class="hljs-attr">componentDidMount</span> : <span class="hljs-string">'reverse'</span>,
    <span class="hljs-attr">componentWillReceiveProps</span> : <span class="hljs-string">'reverse'</span>,
    <span class="hljs-attr">shouldComponentUpdate</span> : <span class="hljs-string">'some'</span>,
    <span class="hljs-attr">componentWillUpdate</span> : <span class="hljs-string">'reverse'</span>,
    <span class="hljs-attr">componentDidUpdate</span> : <span class="hljs-string">'reverse'</span>,
    <span class="hljs-attr">componentWillUnmount</span> : <span class="hljs-string">'sequence'</span>,
});
</code></pre>
<p>Mixin merge rules can be extented in any subclass using the <code>@mixinRules({ attr : rule })</code> class decorator. Rule is the string from the following list.</p>
<ul>
<li><em>merge</em> - assume property to be an object, which members taken from mixins must be merged.</li>
<li><em>pipe</em> - property is the function <code>( x : T ) =&gt; T</code> transforming the value. Multiple functions joined in pipe.</li>
<li><em>sequence</em> - property is the function. Multiple functions will be called in sequence.</li>
<li><em>reverse</em> - same as <em>sequence</em>, but functions called in reverse sequence.</li>
<li><em>mergeSequence</em> - merge the object returned by functions, executing them in sequence.</li>
<li><em>every</em> - property is the function <code>( ...args : any[] ) =&gt; boolean</code>. Resulting method will return true if every single function returns true.</li>
<li><em>some</em> - same as previous, but method will return true when at least one function returns true.</li>
</ul>
<p>If merge rule is an object, the corresponding member is expected to be an object and the rule defines the merge rules for its members.</p>
<h3 id="usage-example">Usage Example</h3>
<p>Here we adding <a href="http://backbonejs.org/#Events">Events</a> support (on, off, trigger, listenTo, etc.):</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { mixins, Events } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-r/mixture'</span>

<span class="hljs-keyword">const</span> UnsubscribeMixin = {
    componentWillUnmount(){
        <span class="hljs-keyword">this</span>.off();
        <span class="hljs-keyword">this</span>.stopListening();
    }
}

@mixins( Events, UnsubscribeMixin )
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventedComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h2 id="events">Events</h2>
<p>Mixture is an alternative implementation of <a href="http://backbonejs.org/#Events">Backbone API for Events</a> heavily optimized for modern JIT engines. Here&#39;s the results of the typical
run of the <a href="https://github.com/Volicon/mixturejs/tree/master/tests">performance tests</a>.</p>
<p><img src="https://raw.githubusercontent.com/Volicon/mixturejs/master/perf-chart.jpg" alt="performance"></p>
<p>Mixture Events implements the complete semantic and API of <a href="http://backbonejs.org/#Events">Backbone 1.1.x Events</a>, with the following exceptions:</p>
<ul>
<li><code>source.trigger( &#39;ev1 ev2 ev3&#39; )</code> is not supported. Use <code>source.trigger( &#39;ev1&#39; ).trigger( &#39;ev2&#39; ).trigger( &#39;ev3&#39; )</code> instead.</li>
<li><code>source.trigger( &#39;ev&#39;, a, b, ... )</code> doesn&#39;t support more than 5 event parameters.</li>
<li><code>source.on( &#39;ev&#39;, callback )</code> - callback will <em>not</em> be called in the context of <code>source</code> by default.</li>
</ul>
<p>Events passes the BackboneJS tests suite.</p>
<h2 id="logger">Logger</h2>
<p><code>Logger</code> doesn&#39;t compete with your logging libraries, it helps you to utilize them. It works like that.</p>
<p>You write to the logs as shown below:</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { log } <span class="hljs-keyword">from</span> <span class="hljs-string">'@type-r/mixture'</span>

...

log( <span class="hljs-string">'info'</span>, <span class="hljs-string">'feature:and:topic'</span>, textMessage, { someRelatedData, someOtherData, ... });
</code></pre>
<p>What really happens there is that you&#39;re sending an event. There&#39;s a singlton <code>logger</code> acting as a router for log events. There could be many listeners to the log events, and the one which is listening by default is the console listener, so you get pretty standard logging out of box.</p>
<p>However, here&#39;s the list of things you can do which you can&#39;t do with a standard console logging:</p>
<ul>
<li>When you&#39;re writing the unit test,<ul>
<li>you can easily turn console errors and warnings into exceptions, or</li>
<li>you can turn on log event counter to be used in asserts.</li>
</ul>
</li>
<li>You can selectively turn logging off removing the listeners for the specific log levels. <code>Logger</code> does it by default muting all events except <code>error</code> and <code>warn</code> in production build, but you can override that.</li>
<li>You can add as many custom log event listeners as you want, which simplifies replacement of the logging library.</li>
</ul>
<h3 id="turning-off-the-default-logger">Turning off the default logger</h3>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"@type-r/mixture"</span>

logger.off(); <span class="hljs-comment">// Mute it completely</span>
logger.off( <span class="hljs-string">'warn'</span> ); <span class="hljs-comment">// Mute warn (log levels correspons to the console[level]( msg ))</span>
</code></pre>
<h3 id="selectively-turn-on-logging">Selectively turn on logging</h3>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"@type-r/mixture"</span>

logger.off().logToConsole( <span class="hljs-string">'error'</span> ).logToConsole( <span class="hljs-string">'warn'</span>, /^myfeature:<span class="hljs-regexp">/ );</span>
</code></pre>
<h3 id="throw-exceptions-on-log-messages">Throw exceptions on log messages</h3>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"@type-r/mixture"</span>

logger.off().throwOn( <span class="hljs-string">'error'</span> ).throwOn( <span class="hljs-string">'warn'</span>, /^myfeature:<span class="hljs-regexp">/ );</span>
</code></pre>
<h3 id="count-specific-log-messages-by-level">Count specific log messages by level</h3>
<pre><code class="highlight javascript">import { logger } from "@type-r/mixture"

logger.off().count( 'error' ).throwOn( 'warn', /^myfeature:/ );;

....

assert( !logger.counter.errors &amp;&amp; !logger.counter.warn)
</code></pre>
<h3 id="add-a-new-log-event-listener">Add a new log event listener</h3>
<pre><code class="highlight javascript"><span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"@type-r/mixture"</span>

logger.on( <span class="hljs-string">'error'</span>, ( subject, message, data ) =&gt; {
    <span class="hljs-built_in">console</span>.log( <span class="hljs-string">'There was an error, you know?'</span> );
});
</code></pre>
<h1 id="release-notes">Release Notes</h1>
<h2 id="v4-0">v4.0</h2>
<h3 id="overview">Overview</h3>
<p>The major goals of this release is to bring the support for writing React applications with React hooks and TypeScript.</p>
<h3 id="npm-package-names-changes">npm package names changes</h3>
<p>Renamed npm packages:</p>
<ul>
<li><code>type-r</code> -&gt; <code>@type-r/models</code></li>
<li><code>type-r/ext-types</code> -&gt; <code>@type-r/ext-types</code></li>
<li><code>type-r/globals</code> -&gt; <code>@type-r/globals</code></li>
</ul>
<p>Combined into one package:</p>
<ul>
<li><code>type-r/endpoints/*</code> -&gt; <code>@type-r/endpoints</code></li>
</ul>
<h3 id="-type-r-models-former-type-r-"><code>@type-r/models</code> (former <code>type-r</code>)</h3>
<p>The main <code>type-r</code> package.</p>
<ul>
<li>More accurate TypeScript typings.</li>
<li><code>Linked</code> class representing an abstract reference to the value; the foundation of two-way data-binding.</li>
<li><code>model.$.attrName</code> returns linked attribute used for two-way data binding in React.</li>
<li><code>AttributesMixin</code> - TypeScript interface to inject attribute types into the Model. Attribute decorators are deprecated and will be removed in v5.</li>
</ul>
<h3 id="-type-r-react-new-"><code>@type-r/react</code> (new)</h3>
<p>New hooks-based React binding based on <code>@linked/react</code>:</p>
<ul>
<li>Local component state management with Type-R:<ul>
<li><code>useModel( ModelClass )</code></li>
<li><code>useCollection.of( ModelClass )</code></li>
<li><code>useCollection.ofRefsTo( ModelClass )</code></li>
<li><code>useCollection.subsetOf( collection )</code></li>
</ul>
</li>
<li><code>pureRenderProps</code> - declarative pure render wrapper working with <code>Date</code>, <code>Linked</code>, type-r models and collections.</li>
<li><code>useChanges( modelOrCollection )</code> - update React component when global model or collection changes.</li>
<li><code>useLinked( value )</code> - create linked component state.</li>
<li><code>useIO( async () =&gt; { ... } )</code> - perform an I/O with async functions.</li>
</ul>
<h3 id="-type-r-endpoints-former-type-r-endpoints-"><code>@type-r/endpoints</code> (former <code>type-r/endpoints/*</code>)</h3>
<ul>
<li><code>modelFetchIO</code> - read-only endpoint to fetch models.</li>
<li><code>restfulIO</code> and <code>modelFetchIO</code> supports json data mocking. When <code>mockData</code> option is present, the HTTP is bypassed and I/O is simulated through the <code>memoryIO</code> endpoint. It makes it possible to develop frontend without a test server.</li>
<li><code>restfulIO</code> and <code>modelFetchIO</code> support for templated URLs.</li>
</ul>
<h3 id="-type-r-mixture-new-"><code>@type-r/mixture</code> (new)</h3>
<p>Type-R mixins, events, logging router, and helper functions factored out to the separate package.</p>
<h2 id="v3-0">v3.0</h2>
<h3 id="breaking-changes">Breaking changes</h3>
<p>Changed semantic which needs to be refactored:</p>
<table>
<thead>
<tr>
<th></th>
<th>2.x</th>
<th>3.x</th>
</tr>
</thead>
<tbody>
<tr>
<td>Typeless attribute</td>
<td><code>value(x)</code></td>
<td><code>type(null).value(x)</code></td>
</tr>
<tr>
<td>Infer type from the value</td>
<td><code>x</code> (except functions)</td>
<td><code>value(x)</code>, or <code>x</code> (except functions)</td>
</tr>
<tr>
<td>model.parse() override</td>
<td><code>model._parse(json)</code></td>
<td>no such a method, remove it</td>
</tr>
<tr>
<td>model attributes iteration</td>
<td><code>model.forEachAttr(obj, iteratee)</code></td>
<td><code>model.forEach(iteratee)</code></td>
</tr>
<tr>
<td>Shared object</td>
<td><code>User.shared</code></td>
<td><code>shared( User )</code></td>
</tr>
<tr>
<td>one-to-many relationship</td>
<td><code>RecordClass.from( ref )</code></td>
<td><code>memberOf( ref )</code></td>
</tr>
<tr>
<td>many-to-many relationship</td>
<td><code>CollectionClass.from( ref )</code></td>
<td><code>subsetOf( ref, CollectionClass? )</code></td>
</tr>
<tr>
<td>construct from object/array</td>
<td>-</td>
<td><code>RecordOrCollectionClass.from( json, options? )</code></td>
</tr>
</tbody>
</table>
<h3 id="new-attribute-definition-notation">New attribute definition notation</h3>
<p>Starting from version 3.X, Type-R does not modify built-in global JS objects. New <code>type(T)</code> attribute definition notation is introduced to replace <code>T.has.</code></p>
<p>There&#39;s <code>type-r/globals</code> package for compatibility with version 2.x which must be imported once with <code>import &#39;type-r/globals&#39;</code>.
If this package is not used, the code must be refactored according to the rules below.</p>
<table>
<thead>
<tr>
<th></th>
<th>2.x</th>
<th>3.x</th>
</tr>
</thead>
<tbody>
<tr>
<td>UNIX Timestamp</td>
<td><code>Date.timestamp</code></td>
<td><code>import { Timestamp } from &#39;type-r/ext-types&#39;</code></td>
</tr>
<tr>
<td>Microsoft date</td>
<td><code>Date.microsoft</code></td>
<td><code>import { MicrosoftDate } from &#39;type-r/ext-types&#39;</code></td>
</tr>
<tr>
<td>Integer</td>
<td><code>Integer</code> and <code>Number.integer</code></td>
<td><code>import { Integer } from &#39;type-r/ext-types&#39;</code></td>
</tr>
<tr>
<td>Create metatype from constructor</td>
<td><code>Ctor.has</code></td>
<td><code>type(Ctor)</code></td>
</tr>
<tr>
<td>Typed attribute with default value</td>
<td><code>Ctor.value(default)</code></td>
<td><code>type(Ctor).value(default)</code></td>
</tr>
<tr>
<td>Attribute &quot;Required&quot; check</td>
<td><code>Ctor.isRequired</code></td>
<td><code>type(Ctor).required</code></td>
</tr>
</tbody>
</table>
<h3 id="first-class-typescript-support">First-class TypeScript support</h3>
<ul>
<li><code>Infer&lt;typeof Metatype&gt;</code> infers TypeScript type from the Type-R attribute metatype.</li>
<li><code>InferAttrs&lt;typeof attributes&gt;</code> infers TypeScript type for the Type-R attributes definitions.</li>
<li><code>attributes({ attrDefs })</code> returns the properly typed TypeScript Model class.</li>
</ul>
<p>TypeScript attributes definitions:</p>
<table>
<thead>
<tr>
<th></th>
<th>2.x</th>
<th>3.x</th>
</tr>
</thead>
<tbody>
<tr>
<td>Extract Type-R type with Reflect.metadata</td>
<td><code>@attr name : T</code></td>
<td><code>@auto name : T</code></td>
</tr>
<tr>
<td>Extract Type-R type &amp; specify the default value</td>
<td>not possible</td>
<td><code>@auto(default) name : T</code></td>
</tr>
<tr>
<td>Explicitly specify the type</td>
<td><code>@attr(T) name : T</code></td>
<td><code>@type(T).as name : T</code></td>
</tr>
<tr>
<td>Infer Type-R type from default value</td>
<td><code>@attr(default) name : T</code></td>
<td><code>@value(default).as name : T</code></td>
</tr>
<tr>
<td>Specify type and default value</td>
<td><code>@attr(T.value(default)) name : T</code></td>
<td><code>@type(T).value(default).as name : T</code></td>
</tr>
</tbody>
</table>
<h3 id="other-improvements">Other improvements</h3>
<ul>
<li><code>Collection</code> class now proxies ES6 Array methods</li>
<li>New logger API which easy to override or turn off.</li>
<li>Improved error messages.</li>
<li><code>Type.from( json, options? )</code> method to restore object from JSON with a strict type check and validation.</li>
</ul>
<pre><code class="highlight typescript"><span class="hljs-meta">@define</span> <span class="hljs-keyword">class</span> User <span class="hljs-keyword">extends</span> Model {
    <span class="hljs-comment">// There's an HTTP REST enpoint for users.</span>
    <span class="hljs-keyword">static</span> endpoint = restfulIO( <span class="hljs-string">'/api/users'</span> );

    <span class="hljs-meta">@auto</span> name : <span class="hljs-built_in">string</span>

    <span class="hljs-comment">// Collection of Role models represented as an array of role.id in JSON.</span>
    <span class="hljs-comment">// When the "roles" attribute will be accessed for the first time,</span>
    <span class="hljs-comment">// User will look-up for a 'roles' attribute of the nearest store to resolve ids to actual Users.</span>
    <span class="hljs-meta">@subsetOf</span>( <span class="hljs-string">'~roles'</span> ).as roles : Collection&lt;Role&gt;
}

<span class="hljs-meta">@define</span> <span class="hljs-keyword">class</span> Role <span class="hljs-keyword">extends</span> Model {
    <span class="hljs-keyword">static</span> endpoint = restfulIO( <span class="hljs-string">'/api/roles'</span> );
    <span class="hljs-meta">@auto</span> name : <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">// Store is the regular Model, nothing special.</span>
<span class="hljs-meta">@define</span> <span class="hljs-keyword">class</span> UsersDirectory <span class="hljs-keyword">extends</span> Store {
    <span class="hljs-comment">// When this model is fetched, fetch all the attributes instead.</span>
    <span class="hljs-keyword">static</span> endpoint = attributesIO();

    <span class="hljs-comment">// '~roles' references from all aggregated collections</span>
    <span class="hljs-comment">// will point to here, because this is the nearest store.</span>
    <span class="hljs-meta">@type</span>( User.Collection ).as users : Collection&lt;User&gt;
    <span class="hljs-meta">@type</span>( Role.Collection ).as roles : Collection&lt;Role&gt;
}

<span class="hljs-keyword">const</span> directory = <span class="hljs-keyword">new</span> UsersDirectory();
<span class="hljs-keyword">await</span> directory.fetch();

<span class="hljs-keyword">for</span>( <span class="hljs-keyword">let</span> user of directory.users ){
    assert( user.roles.first().users.first() instanceOf User );
}
</code></pre>
<h2 id="v2-1">v2.1</h2>
<p>This release adds long-awaited HTTP REST endpoint.</p>
<ul>
<li>IO endpoints moved outside of the man sources tree. Creation of the custom endpoints is easier than ever.</li>
<li>Added HTTP REST endpoint <code>restfulIO</code> with relative urls support (<a href="https://volicon.github.io/Type-R/#endpoint-restfulio-url-options-)">https://volicon.github.io/Type-R/#endpoint-restfulio-url-options-)</a>.</li>
<li>Added proxyIO endpoint for creating endpoints from models on the server side (<a href="https://volicon.github.io/Type-R/#endpoint-proxyio-recordctor-)">https://volicon.github.io/Type-R/#endpoint-proxyio-recordctor-)</a>.</li>
</ul>
<h2 id="v2-0">v2.0</h2>
<p>This release brings new features which fixes problems with component&#39;s inheritance in React bindings and implements long-awaited generic IO implementation based on ES6 promises.</p>
<p>There shouldn&#39;t be breaking changes <em>unless</em> you&#39;re using custom logger or React bindings (formerly known as React-MVx, with a name changed to React-R in new release).</p>
<h3 id="generic-io-support">Generic IO support</h3>
<p>New <a href="">IOEndpoint</a> concept is introduced, making it easy to create IO abstractions. To enable <code>Model</code> and <code>Collection</code> IO API, you need to assign IO endpoint in the class definition.</p>
<p>Endpoint is the class defining CRUD and list operations on JSON data, as well as the methods to subscribe for the data changes. There are two endpoints included with 2.0 release, <code>memoryIO</code> which is suitable for mock testing and <code>localStorageIO</code> which could be used in demos and prototypes. They can be used as a references as starting points to define your own IO endpoints.</p>
<pre><code class="highlight javascript">@define <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span> </span>{
    <span class="hljs-keyword">static</span> endpoint = memoryIO();
    <span class="hljs-keyword">static</span> attributes = {
        <span class="hljs-attr">name</span> : <span class="hljs-built_in">String</span>,
        ...
    }
}
</code></pre>
<p>There are three Model IO methods (<code>save()</code>, <code>fetch()</code>, and <code>destroy()</code>) and two collection IO method (<code>fetch()</code> and <code>liveUpdates()</code>) ). All IO methods returns ES6 promises, so you either must have the runtime supporting ES6 or use the ES6 promise polyfill. The promises are modified to be <em>abortable</em> (all of them have <code>abort()</code> method).</p>
<pre><code class="highlight javascript"><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> User({ <span class="hljs-attr">name</span> : <span class="hljs-string">'John'</span> });
user.save().then( <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-built_in">console</span>.log( <span class="hljs-string">`new user is added <span class="hljs-subst">${ user.id }</span>`</span> )
});
</code></pre>
<p>There&#39;s the special <code>attributesIO()</code> endpoint to fetch all of attributes independently and return the combined promise. This is the recommended way of fetching the data required by SPA page.</p>
<pre><code class="highlight javascript">@define <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Store</span> </span>{
    <span class="hljs-keyword">static</span> endpoint = attributesIO();
    <span class="hljs-keyword">static</span> attributes = {
        <span class="hljs-attr">users</span> : User.Collection,
        <span class="hljs-attr">roles</span> : UserRole.Collection,
        ...
    }
}

<span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> PageStore();
store.fetch().then( <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>{
    <span class="hljs-comment">// render your page</span>
});
</code></pre>
<p>It&#39;s possible to define or override the defined endpoint for the nested model or collection using <code>type().endpoint()</code> type-R attribute annotation.</p>
<pre><code class="highlight javascript">@define <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Store</span> </span>{
    <span class="hljs-keyword">static</span> endpoint = attributesIO();
    <span class="hljs-keyword">static</span> attributes = {
        <span class="hljs-attr">users</span> : type( User.Collection ).endpoint( restful( <span class="hljs-string">'/api/users'</span> ) ),
        <span class="hljs-attr">roles</span> : type( UserRole.Collection ).endpoint( restful( <span class="hljs-string">'/api/userroles'</span> ) ),
        ...
    }
}
</code></pre>
<aside class="notice">
Please note, that `restful` endpoint is not included with 2.0 release but is planned for the future 2.x releases.
</aside>

<h3 id="new-mixins-engine">New mixins engine</h3>
<p>Type-R metaprogramming system built on powerful mixins composition with configurable member merge rules. In 2.0 release, mixins engine was rewritten to properly apply merge rules on inheritance. This feature is heavily used in Type-R React&#39;s bindings and is crucial to prevent errors when extending the <code>React.Component</code> subclasses.</p>
<p>An example illustrating the principle:</p>
<pre><code class="highlight javascript">@define
<span class="hljs-comment">// Define the class with </span>
@mixinRules({
    <span class="hljs-attr">componentWillMount</span> : mixinRules.classLast,
    <span class="hljs-attr">componentWillUnmount</span> : mixinRules.classFirst
})
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Component</span> </span>{
    componentWillMount(){
        <span class="hljs-built_in">console</span>.log( <span class="hljs-number">1</span> );
    }

    componentWillUnmount(){
        <span class="hljs-built_in">console</span>.log( <span class="hljs-number">3</span> );
    }
}

@define
@mixins({
    componentWillMount(){
        <span class="hljs-built_in">console</span>.log( <span class="hljs-number">2</span> );
    },

    componentWillUnmount(){
        <span class="hljs-built_in">console</span>.log( <span class="hljs-number">2</span> );
    }
})
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBaseComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>{
    componentWillMount(){
        <span class="hljs-built_in">console</span>.log( <span class="hljs-number">3</span> );
    }

    componentWillUnmount(){
        <span class="hljs-built_in">console</span>.log( <span class="hljs-number">1</span> );
    }
}
</code></pre>
<p>In this example, all of the methods defined in the mixin, base class, and subclass will be called in the order specified in the <code>console.log</code>.</p>
<h3 id="other-changes">Other changes</h3>
<ul>
<li>Update pipeline was rewritten to improve model&#39;s initialization speed (collection&#39;s fetch speed is improved by 30%).</li>
<li>Fixed bug causing dynamic type checks to be disabled in models constructors.</li>
<li>New implementation of the <code>Collection.subsetOf</code> which both fixes some edge case bugs and is more efficient.</li>
<li>New logger handling NODE_ENV variable setting.</li>
</ul>
        </div>
    </div>
  </body>
</html>
